# CellProfiler Analysis 

In this stage of the pipeline, we will generate the nuclear segmentation, measure the properties of our choosing for the nucleus and cytoplasm, and conduct object tracking for live cell imaging. We will first explain the main stages in the pipeline and the expected output for each stage. Details for optimizable parameters will then be discussed. 

## Stages of the CellProfiler Analysis 
If you download the "CellProfier_pipeline.cpproj" file, you will see that there are multiple stages in the pipeline as denoted in the white tab on the left of the software. A description of the purpose of each stage is explained in the table below: 

|Stage|Purpose|
|------|------|
_Images_|Input the required images for segmentation. In this pipeline, we have added the: <br /> 1) Modified SiR-DNA images from Fiji <br />2) Original SiR-DNA and KTR images for property measurement later <br />3) Cell objects generated from CellPose 
_Metadata_|The data uploaded here is a stacked tiff file consisting of 33 individual photos (representing the live cell imaging video). The Metadata stage tells CellProfiler that each individual photo is a frame in the video to facilitate object tracking. 
_NamesAndTypes_|This step tells CellProfiler, to categorize uploaded images from Images:<br /> 1)Modified sir-DNA images are called ‘Edited_DAPI’<br />2)Original SiR-DNA and KTR images are called ‘Original_DAPI’ and ‘KTR’ respectively<br />3)Cell objects generated from CellPose are converted to CellProfiler objects called ‘Cell_mask_raw’ 
_Groups_|Groups the input images by frames for ease of property measurement downstream. 
_EditObjectsManually_|_EditObjectsManually_ allows you to correct the CellPose segmentation errors if you would like to. If the segmentation already works well for you, you can untick the checkbox and skip this step. 
_IdentifyPrimaryObjects_|CellProfiler identifies individual objects as “Nucleus_raw” using the modified SiR-DNA images ![image](https://user-images.githubusercontent.com/46695970/122502613-85164d80-d029-11eb-99e4-c1775642ac30.png)
_EditObjectsManually_|_EditObjectsManually_ allows you to correct nuclear CellProfiler segmentation errors if you would like to. If the segmentation already works well for you, you can untick the checkbox and skip this step. 
_RelateObjects_|Since the nuclear and cell objects are identified by two different software (CellPose and CellProfiler),the cell and its corresponding nucleus is labelled with a different number. To ensure that each nucleus is labelled with the same number as its cell, the _RelateObjects_ function is used.![image](https://user-images.githubusercontent.com/46695970/122503879-c576cb00-d02b-11eb-8214-06090e60c2fb.png)
_IdentifyTertiaryObjects_|To isolate the cytoplasm, the nucleus was subtracted from the CellPose cell masks.![image](https://user-images.githubusercontent.com/46695970/122503782-a2e4b200-d02b-11eb-9952-6f17d5bb4565.png) 
_IdentifyTertiaryObjects_|There are certain categories of cells which do not generate a CellPose cell mask for the individual cell, including dividing cells, cells with signal only in the nucleus, and normal cells with segmentation errors. The subsequent steps help identify these cells so we can measure the properties of these objects if need be. In the project we are working on, we are interested in tracking dividing cells over time and hence go into great detail about how these cells can be identified. If the pipeline already isolates most of the cells you need, you can skip the _IdentifyTertiaryObjects_ and _IdentifySecondaryObjects_ function. <br /> In this _IdentifyTertiaryObjects_ function,  we identify a subset of the original nuclei objects identified called Nucleus_2. These cells have a CellPose mask associated with them. ![image](https://user-images.githubusercontent.com/46695970/122505682-6f0b8b80-d02f-11eb-975e-4f8845b13a0d.png)
_IdentifyTertiaryObjects_| This is a repeat of the above step, but the smaller object is shrunk prior to subtraction. Called Nucleus_2_fortracking, this generates microscopy images with the nucleus and the CellPose cell mask boundary. It is not used for data analysis, but provides an easy way to see the visualization of the object tracking tool downstream of the CellProfiler analysis tool. More details are explained below. ![image](https://user-images.githubusercontent.com/46695970/122509913-353e8300-d037-11eb-89c3-a3cfc8bc1d10.png)
_IdentifyTertiaryObjects_| Using the Nucleus_2 subset, we can then subtract the Nucleus_2 subset from the Nucleus_raw subset to obtain the Leftover_nucleus, a set of nuclei that do not have a CellPose mask associated with it. ![image](https://user-images.githubusercontent.com/46695970/122508179-21dde880-d034-11eb-934e-f88d8e9c900a.png)
_IdentifySecondaryObjects_|To identify dividing cells and cells with a nuclear-only signal, the Nucleus_2 subset is expanded by 5 pixels to check the surrounding intensity of the nuclei. If there is a high-value cytoplasmic intensity around the nucleus, this cell is likely to be normal, and that there was some error in CellPose. If the surrounding intensity is minimal and near background intensity, this cell is likely to be a dividing cell or a cell with nuclear-only signal. These cells can then be labelled and properties can be analyzed separately. ![image](https://user-images.githubusercontent.com/46695970/122510056-7fbfff80-d037-11eb-91d9-8eeb57bbbe04.png)
_DisplayDataonImage_|Number labels for each cell object is imprinted onto the KTR channel to assist data analysis. ![image](https://user-images.githubusercontent.com/46695970/122509968-50a98e00-d037-11eb-8410-6c0d9a8e6b9c.png)
_DisplayDataonImage_|Number labels for each nuclear object is imprinted onto the SiR-DNA channel to assits data analysis. ![image](https://user-images.githubusercontent.com/46695970/122509984-5ef7aa00-d037-11eb-870d-9fca3b48b149.png)
_MeasureObjectIntensity_<br />_MeasureObjectIntensityDistribution_<br />_MeasureObjectNeighbors_<br />_MeasureObjectSizeShape_| Properties of our chooing are then measured for data analysis. 
_TrackObjects_| Nucleus_2_fortracking is tracked over different frames in a live-cell imaging video. This tracking is purely for visualization and ease of checking for errors during tracking or segmentation. 
_TrackObjects_| Nucleus_2 is tracked over different frames in the live-cell imaging video. With this tracking tool, objects will be labelled with the same number under "TrackObjectsLabel" across different frames. 
_ExportToSpreadsheet_| All data generated is exported into a spreadsheet for further analysis. 
_SaveImages_| Visualizations of the tracking, labelled images from _DisplayDataonImage_ will be saved into an output folder. 

## Optimizable Parameters 

### Nuclear Segmentation
When you click on each individual stage, there are parameters which can be optimized for your images. Across different image conditions, I have found that I have only needed to optimized 3 factors in the _IdentifyPrimaryObjects_ as shown below: 
![image](https://user-images.githubusercontent.com/46695970/122512275-35d91880-d03b-11eb-8599-7b3f984f0d12.png)
All 3 factors are optimized by visual inspection of the error rate of segmentation. For threshold strategy and thresholding method, you should try all possible permutations and combinations of the options in the drop-down menu provided. 

### Object Tracking
![image](https://user-images.githubusercontent.com/46695970/123042294-2ede4b80-d429-11eb-8bbe-7f0c798e842d.png)

You can also decide which properties of the nucleus and cytoplasm you would like to measure, and what measurements you want to export in your final spreadsheet. These can be changed under the _MeasureObjectIntensity_, _MeasureObjectIntensityDistribution_, _MeasureObjectNeighbors_,_MeasureObjectSizeShape_ and _ExportToSpreadsheet_ function. 

